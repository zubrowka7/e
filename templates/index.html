<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Моніторинг споживання електроенергії</title>

<style>
body{
  margin:0;
  padding:20px;
  background:#121212;
  font-family:system-ui,sans-serif;
  color:#fff;
}
.header{
  text-align:center;
  font-size:18px;
  font-weight:600;
  margin-bottom:20px;
  color:#eee;
}
.dashboard{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  max-width:1100px;
  margin:auto;
}
.card{
  background:#1e1e1e;
  border-radius:14px;
  padding:14px 16px;
  height:180px;
  position:relative;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
}
.title{font-size:13px;color:#aaa;}
.value-row{
  display:flex;
  align-items:baseline;
  gap:6px;
  margin-top:6px;
}
.value{
  font-size:32px;
  font-weight:600;
  line-height:1;
}
.unit{font-size:14px;color:#aaa;}
.chart{
  position:absolute;
  left:0;
  right:0;
  bottom:6px;
}

@media(max-width:768px){
  .dashboard{grid-template-columns:repeat(2,1fr);}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>

<div class="header">Моніторинг споживання електроенергії</div>
<div class="dashboard" id="dashboard"></div>

<script>
const metrics=[
  {k:"voltage",t:"Напруга",u:"В",c:"#4fc3f7",min:0,max:250},
  {k:"current",t:"Струм",u:"А",c:"#ff7043",min:0,max:1},
  {k:"power",t:"Потужність",u:"Вт",c:"#ab47bc",min:0,max:200},
  {k:"energy",t:"Енергія",u:"кВт·год",c:"#66bb6a",min:0,max:5},
  {k:"frequency",t:"Частота",u:"Гц",c:"#ffee58",min:0,max:65},
  {k:"pf",t:"Коефіцієнт потужності",u:"",c:"#26c6da",min:0,max:1}
];

const MAX_POINTS=20;
const values={},times=[];
const charts={};
const root=document.getElementById("dashboard");

metrics.forEach(m=>{
  values[m.k]=[];

  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <div class="title">${m.t}</div>
    <div class="value-row">
      <div class="value" id="v-${m.k}" style="color:${m.c}">0</div>
      <div class="unit">${m.u}</div>
    </div>
    <div class="chart" id="c-${m.k}"></div>
  `;
  root.appendChild(card);

  charts[m.k]=new ApexCharts(
    document.getElementById(`c-${m.k}`),
    {
      chart:{type:"area",height:90,sparkline:{enabled:true}},
      series:[{data:[]}],
      colors:[m.c],
      stroke:{curve:"smooth",width:2},
      fill:{type:"gradient",gradient:{opacityFrom:.45,opacityTo:.05}},
      yaxis:{min:m.min,max:m.max},
      xaxis:{categories:[]},
      tooltip:{
        theme:"dark",
        x:{show:false},
        custom:({series,dataPointIndex,w})=>`
          <div style="padding:6px 10px;font-size:12px">
            ${w.globals.categoryLabels[dataPointIndex]}<br>
            ${m.t}: ${series[0][dataPointIndex]} ${m.u}
          </div>`
      }
    }
  );
  charts[m.k].render();
});

async function refresh(){
  const r=await fetch("/api/latest");
  const d=await r.json();
  const now=new Date().toLocaleTimeString("uk-UA",{hour12:false});

  if(times.length>=MAX_POINTS) times.shift();
  times.push(now);

  metrics.forEach(m=>{
    if(values[m.k].length>=MAX_POINTS) values[m.k].shift();
    const val=Number(d[m.k]);
    values[m.k].push(val);
    document.getElementById(`v-${m.k}`).textContent=val;
    charts[m.k].updateSeries([{data:[...values[m.k]]}]);
    charts[m.k].updateOptions({xaxis:{categories:[...times]}});
  });
}

setInterval(refresh,10000);
</script>

</body>
</html>
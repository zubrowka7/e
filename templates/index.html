<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Моніторинг споживання електроенергії</title>

<style>
body{
  margin:0;
  padding:20px;
  background:#121212;
  color:#fff;
  font-family:system-ui,sans-serif;
}
.header{
  font-size:18px;
  font-weight:600;
  text-align:center;
  margin-bottom:20px;
  color:#eee;
}
.dashboard{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  max-width:1100px;
  margin:auto;
}
.card{
  position:relative;
  height:180px;
  padding:14px 16px;
  background:#1e1e1e;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
}
.title{font-size:13px;color:#aaa;}
.value-row{display:flex;align-items:baseline;gap:6px;margin-top:6px;}
.value{font-size:32px;font-weight:600;line-height:1;}
.unit{font-size:14px;color:#aaa;}
.chart{position:absolute;left:0;right:0;bottom:6px;}

@media(max-width:768px){
  .dashboard{grid-template-columns:repeat(2,1fr);}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>

<div class="header">Моніторинг споживання електроенергії</div>
<div class="dashboard" id="dashboard"></div>

<script>
const cardsData = [
  {key:"voltage",title:"Напруга",unit:"В",color:"#4fc3f7",min:0,max:250},
  {key:"current",title:"Струм",unit:"А",color:"#ff7043",min:0,max:50},
  {key:"power",title:"Потужність",unit:"Вт",color:"#ab47bc",min:0,max:10000},
  {key:"energy",title:"Енергія",unit:"кВт·год",color:"#66bb6a",min:0,max:5000},
  {key:"frequency",title:"Частота",unit:"Гц",color:"#ffee58",min:45,max:55},
  {key:"pf",title:"Коефіцієнт потужності",unit:"",color:"#26c6da",min:0,max:100}
];

const MAX_POINTS = 20;
let categories = [];
const charts = {};
const dataStore = {};
const container = document.getElementById("dashboard");

cardsData.forEach(c=>{
  dataStore[c.key] = [];

  container.insertAdjacentHTML("beforeend",`
    <div class="card">
      <div class="title">${c.title}</div>
      <div class="value-row">
        <div class="value" id="value-${c.key}" style="color:${c.color}">0</div>
        <div class="unit">${c.unit}</div>
      </div>
      <div class="chart" id="chart-${c.key}"></div>
    </div>
  `);

  charts[c.key] = new ApexCharts(
    document.getElementById(`chart-${c.key}`),
    {
      chart:{type:"area",height:90,sparkline:{enabled:true}},
      series:[{data:[]}],
      colors:[c.color],
      stroke:{curve:"smooth",width:2},
      fill:{type:"gradient",gradient:{opacityFrom:.45,opacityTo:.05}},
      yaxis:{min:c.min,max:c.max},
      xaxis:{categories:[]},
      tooltip:{
        theme:"dark",
        x:{show:false},
        custom:({series,dataPointIndex,w})=>`
          <div style="padding:6px 10px;font-size:12px">
            ${w.globals.categoryLabels[dataPointIndex]}<br>
            ${c.title}: ${parseInt(series[0][dataPointIndex])} ${c.unit}
          </div>`
      }
    }
  );
  charts[c.key].render();
});

function updateDashboard(data){
  const now = new Date().toLocaleTimeString("uk-UA");

  if(categories.length === MAX_POINTS) categories.shift();
  categories.push(now);

  cardsData.forEach(c=>{
    if(dataStore[c.key].length === MAX_POINTS) dataStore[c.key].shift();
    const value = parseInt(data[c.key]);
    dataStore[c.key].push(value);
    document.getElementById(`value-${c.key}`).textContent = value;
    charts[c.key].updateSeries([{data:dataStore[c.key]}]);
    charts[c.key].updateOptions({xaxis:{categories}});
  });
}

setInterval(async ()=>{
  const r = await fetch("/api/latest");
  updateDashboard(await r.json());
},10000);
</script>

</body>
</html>
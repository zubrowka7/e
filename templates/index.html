<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Моніторинг споживання електроенергії</title>

<style>
body{
  margin:0;
  background:#121212;
  font-family:system-ui, sans-serif;
  padding:20px;
  color:#fff;
}
.header{
  font-size:18px;
  font-weight:600;
  text-align:center;
  margin-bottom:20px;
  color:#eee;
}
.dashboard{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:16px;
  max-width:1100px;
  margin:auto;
}
.card{
  background:#1e1e1e;
  border-radius:14px;
  padding:14px 16px;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  height:180px;
  position:relative;
}
.title{font-size:13px;color:#aaa;}
.value-row{display:flex;align-items:baseline;gap:6px;margin-top:6px;}
.value{font-size:32px;font-weight:600;line-height:1;}
.unit{font-size:14px;color:#aaa;}
.chart{position:absolute;left:0;right:0;bottom:6px;}

@media screen and (max-width:768px){
  .dashboard{
    grid-template-columns:repeat(2, 1fr);
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>

<div class="header">Моніторинг споживання електроенергії</div>
<div class="dashboard" id="dashboard"></div>

<script>
const cardsData = [
  {key:"voltage", title:"Напруга", unit:"В", color:"#4fc3f7"},
  {key:"current", title:"Струм", unit:"А", color:"#ff7043"},
  {key:"power", title:"Потужність", unit:"Вт", color:"#ab47bc"},
  {key:"energy", title:"Енергія", unit:"кВт·год", color:"#66bb6a"},
  {key:"frequency", title:"Частота", unit:"Гц", color:"#ffee58"},
  {key:"pf", title:"Коефіцієнт потужності", unit:"", color:"#26c6da"}
];

const MAX_POINTS = 20;
let categories = [];
const charts = {};
const dataStore = {};

const container = document.getElementById("dashboard");

cardsData.forEach((c,i)=>{
  dataStore[c.key] = [];

  const card = document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <div class="title">${c.title}</div>
    <div class="value-row">
      <div class="value" style="color:${c.color}" id="value-${c.key}">0</div>
      <div class="unit">${c.unit}</div>
    </div>
    <div class="chart" id="chart-${c.key}"></div>
  `;
  container.appendChild(card);

  charts[c.key] = new ApexCharts(
    document.querySelector(`#chart-${c.key}`),
    {
      chart:{type:"area",height:90,sparkline:{enabled:true}},
      series:[{data:[]}],
      colors:[c.color],
      stroke:{curve:"smooth",width:2},
      fill:{type:"gradient",gradient:{opacityFrom:0.45,opacityTo:0.05}},
      xaxis:{categories:[]},
      tooltip:{
        enabled:true,
        theme:"dark",
        x:{show:false},
        custom:({series,seriesIndex,dataPointIndex,w})=>{
          const time = w.globals.categoryLabels[dataPointIndex];
          const val = Number(series[0][dataPointIndex]).toFixed(2);
          return `
            <div style="padding:6px 10px;font-size:12px;color:#fff">
              ${time}<br>
              ${c.title}: ${val} ${c.unit}
            </div>`;
        }
      }
    }
  );
  charts[c.key].render();
});

function updateDashboard(data){
  const now = new Date().toLocaleTimeString("uk-UA");

  if(categories.length >= MAX_POINTS) categories.shift();
  categories.push(now);

  cardsData.forEach(c=>{
    if(dataStore[c.key].length >= MAX_POINTS)
      dataStore[c.key].shift();

    dataStore[c.key].push(data[c.key]);

    document.getElementById(`value-${c.key}`).textContent =
      Number(data[c.key]).toFixed(2);

    charts[c.key].updateSeries([{data:[...dataStore[c.key]]}]);
    charts[c.key].updateOptions({xaxis:{categories:[...categories]}});
  });
}

setInterval(async ()=>{
  const r = await fetch("/api/latest");
  const d = await r.json();
  updateDashboard(d);
},15000);
</script>

</body>
</html>